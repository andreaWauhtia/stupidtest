<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta http-equiv="Permissions-Policy" content="accelerometer=(), magnetometer=(), gyroscope=()">
    
    <title>Test Capteur Orientation</title>
    <style>
        body { font-family: monospace; padding: 20px; font-size: 16px; -webkit-font-smoothing: antialiased;}
        #status, #info { padding: 10px; background-color: #f0f0f0; border: 1px solid #ccc; margin-bottom: 10px; }
        #data { white-space: pre; font-weight: bold; font-size: 20px;}
        button { font-size: 18px; padding: 12px 20px; }
    </style>
</head>
<body>
    <h1>Test du Capteur d'Orientation</h1>
    <div id="status">En attente d'interaction...</div>
    <div id="info" style="display: none;"></div>
    <hr>
    <div id="data"></div>

    <script>
        const statusEl = document.getElementById('status');
        const infoEl = document.getElementById('info');
        const dataEl = document.getElementById('data');

        statusEl.innerHTML = '<button id="perm_button">Démarrer le test</button>';
        const button = document.getElementById('perm_button');

        button.onclick = () => {
            statusEl.textContent = 'Demande de permission...';

            // La demande de permission unifiée est la meilleure approche
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission().then(permissionState => {
                    if (permissionState === 'granted') {
                        startSensor();
                    } else {
                        statusEl.textContent = 'Permission refusée.';
                    }
                }).catch(err => {
                    statusEl.textContent = `Erreur permission: ${err.message}`;
                });
            } else {
                startSensor();
            }
        };

        function startSensor() {
            // Test de la présence de l'API moderne
            if ('AbsoluteOrientationSensor' in window) {
                statusEl.textContent = 'API Moderne (AbsoluteOrientationSensor) détectée.';
                try {
                    const sensor = new AbsoluteOrientationSensor({ frequency: 60 });
                    sensor.onreading = () => {
                        const q = sensor.quaternion;
                        const yaw = Math.atan2(2.0 * (q[0] * q[1] + q[3] * q[2]), 1.0 - 2.0 * (q[1] * q[1] + q[2] * q[2]));
                        const heading = (yaw * 180 / Math.PI + 360) % 360;
                        
                        infoEl.style.display = 'block';
                        infoEl.textContent = "Capteur démarré. Tournez le téléphone."
                        dataEl.innerHTML = `Heading (Cap calculé): \n${heading.toFixed(1)}°`;
                    };
                    sensor.onerror = (event) => {
                        statusEl.textContent = `Erreur capteur: ${event.error.name}`;
                        infoEl.textContent = event.error.message;
                    };
                    sensor.start();
                } catch (error) {
                    statusEl.textContent = `Erreur initialisation: ${error.name}`;
                    infoEl.textContent = error.message;
                }
            } else {
                statusEl.textContent = 'API Moderne non supportée.';
            }
        }
    </script>
</body>
</html>
